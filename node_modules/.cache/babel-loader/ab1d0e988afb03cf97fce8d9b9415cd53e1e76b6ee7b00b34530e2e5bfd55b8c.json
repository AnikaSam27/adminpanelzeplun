{"ast":null,"code":"/* --------------------------------------------------------\r\n   üîî OrderNotifier.js  \r\n   Safe global listener for new orders ‚Üí Telegram + WhatsApp\r\n-------------------------------------------------------- */\n\nimport { collection, onSnapshot } from \"firebase/firestore\";\nimport { db } from \"../firebase\";\nimport { sendTelegramUpdate, sendWhatsAppUpdate } from \"./notifications\";\nlet listenerStarted = false;\nexport const startOrderNotificationListener = () => {\n  if (listenerStarted) {\n    console.log(\"‚ö†Ô∏è Listener already running ‚Äî skipping duplicate.\");\n    return;\n  }\n\n  // Ensure Firestore is ready before attaching listener\n  if (!db) {\n    console.error(\"‚ùå Firestore not initialized yet!\");\n    return;\n  }\n  listenerStarted = true;\n  console.log(\"üöÄ Global Order Listener Started\");\n  let notifiedOrders = new Set(JSON.parse(localStorage.getItem(\"notifiedOrders\") || \"[]\"));\n  const ordersRef = collection(db, \"orders\"); // SAFE ‚Äî db is guaranteed now\n\n  onSnapshot(ordersRef, async snapshot => {\n    const ordersList = snapshot.docs.map(doc => ({\n      id: doc.id,\n      ...doc.data()\n    }));\n    ordersList.sort((a, b) => {\n      var _b$timestamp, _a$timestamp;\n      return (((_b$timestamp = b.timestamp) === null || _b$timestamp === void 0 ? void 0 : _b$timestamp.seconds) || 0) - (((_a$timestamp = a.timestamp) === null || _a$timestamp === void 0 ? void 0 : _a$timestamp.seconds) || 0);\n    });\n    const newOrders = ordersList.filter(order => !notifiedOrders.has(order.id) && order.status === \"booked\");\n    for (const order of newOrders) {\n      const message = `\nüì¶ *New Order Booked!*\n\nüßæ *Order ID:* ${order.orderId}\nüë§ *Customer:* ${order.customerName}\nüìû *Phone:* ${order.customerPhone}\nüóìÔ∏è *Date:* ${order.date}\nüí∞ *Total:* ‚Çπ${order.totalAmount || 0}\n      `;\n\n      // Telegram Admin Alert\n      await sendTelegramUpdate(message);\n\n      // WhatsApp Customer\n      if (order.customerPhone) {\n        const phone = order.customerPhone.replace(/\\D/g, \"\");\n        await sendWhatsAppUpdate(phone, `Your order #${order.orderId} is confirmed! Total: ‚Çπ${order.totalAmount}`);\n      }\n      notifiedOrders.add(order.id);\n    }\n    localStorage.setItem(\"notifiedOrders\", JSON.stringify([...notifiedOrders]));\n  });\n};","map":{"version":3,"names":["collection","onSnapshot","db","sendTelegramUpdate","sendWhatsAppUpdate","listenerStarted","startOrderNotificationListener","console","log","error","notifiedOrders","Set","JSON","parse","localStorage","getItem","ordersRef","snapshot","ordersList","docs","map","doc","id","data","sort","a","b","_b$timestamp","_a$timestamp","timestamp","seconds","newOrders","filter","order","has","status","message","orderId","customerName","customerPhone","date","totalAmount","phone","replace","add","setItem","stringify"],"sources":["C:/Users/anika/admin-panel/src/utils/OrderNotifier.js"],"sourcesContent":["/* --------------------------------------------------------\r\n   üîî OrderNotifier.js  \r\n   Safe global listener for new orders ‚Üí Telegram + WhatsApp\r\n-------------------------------------------------------- */\r\n\r\nimport { collection, onSnapshot } from \"firebase/firestore\";\r\nimport { db } from \"../firebase\";\r\nimport { sendTelegramUpdate, sendWhatsAppUpdate } from \"./notifications\";\r\n\r\nlet listenerStarted = false;\r\n\r\nexport const startOrderNotificationListener = () => {\r\n  if (listenerStarted) {\r\n    console.log(\"‚ö†Ô∏è Listener already running ‚Äî skipping duplicate.\");\r\n    return;\r\n  }\r\n\r\n  // Ensure Firestore is ready before attaching listener\r\n  if (!db) {\r\n    console.error(\"‚ùå Firestore not initialized yet!\");\r\n    return;\r\n  }\r\n\r\n  listenerStarted = true;\r\n  console.log(\"üöÄ Global Order Listener Started\");\r\n\r\n  let notifiedOrders = new Set(\r\n    JSON.parse(localStorage.getItem(\"notifiedOrders\") || \"[]\")\r\n  );\r\n\r\n  const ordersRef = collection(db, \"orders\"); // SAFE ‚Äî db is guaranteed now\r\n\r\n  onSnapshot(ordersRef, async (snapshot) => {\r\n    const ordersList = snapshot.docs.map((doc) => ({\r\n      id: doc.id,\r\n      ...doc.data(),\r\n    }));\r\n\r\n    ordersList.sort(\r\n      (a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)\r\n    );\r\n\r\n    const newOrders = ordersList.filter(\r\n      (order) => !notifiedOrders.has(order.id) && order.status === \"booked\"\r\n    );\r\n\r\n    for (const order of newOrders) {\r\n      const message = `\r\nüì¶ *New Order Booked!*\r\n\r\nüßæ *Order ID:* ${order.orderId}\r\nüë§ *Customer:* ${order.customerName}\r\nüìû *Phone:* ${order.customerPhone}\r\nüóìÔ∏è *Date:* ${order.date}\r\nüí∞ *Total:* ‚Çπ${order.totalAmount || 0}\r\n      `;\r\n\r\n      // Telegram Admin Alert\r\n      await sendTelegramUpdate(message);\r\n\r\n      // WhatsApp Customer\r\n      if (order.customerPhone) {\r\n        const phone = order.customerPhone.replace(/\\D/g, \"\");\r\n        await sendWhatsAppUpdate(\r\n          phone,\r\n          `Your order #${order.orderId} is confirmed! Total: ‚Çπ${order.totalAmount}`\r\n        );\r\n      }\r\n\r\n      notifiedOrders.add(order.id);\r\n    }\r\n\r\n    localStorage.setItem(\"notifiedOrders\", JSON.stringify([...notifiedOrders]));\r\n  });\r\n};\r\n"],"mappings":"AAAA;AACA;AACA;AACA;;AAEA,SAASA,UAAU,EAAEC,UAAU,QAAQ,oBAAoB;AAC3D,SAASC,EAAE,QAAQ,aAAa;AAChC,SAASC,kBAAkB,EAAEC,kBAAkB,QAAQ,iBAAiB;AAExE,IAAIC,eAAe,GAAG,KAAK;AAE3B,OAAO,MAAMC,8BAA8B,GAAGA,CAAA,KAAM;EAClD,IAAID,eAAe,EAAE;IACnBE,OAAO,CAACC,GAAG,CAAC,mDAAmD,CAAC;IAChE;EACF;;EAEA;EACA,IAAI,CAACN,EAAE,EAAE;IACPK,OAAO,CAACE,KAAK,CAAC,kCAAkC,CAAC;IACjD;EACF;EAEAJ,eAAe,GAAG,IAAI;EACtBE,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC;EAE/C,IAAIE,cAAc,GAAG,IAAIC,GAAG,CAC1BC,IAAI,CAACC,KAAK,CAACC,YAAY,CAACC,OAAO,CAAC,gBAAgB,CAAC,IAAI,IAAI,CAC3D,CAAC;EAED,MAAMC,SAAS,GAAGhB,UAAU,CAACE,EAAE,EAAE,QAAQ,CAAC,CAAC,CAAC;;EAE5CD,UAAU,CAACe,SAAS,EAAE,MAAOC,QAAQ,IAAK;IACxC,MAAMC,UAAU,GAAGD,QAAQ,CAACE,IAAI,CAACC,GAAG,CAAEC,GAAG,KAAM;MAC7CC,EAAE,EAAED,GAAG,CAACC,EAAE;MACV,GAAGD,GAAG,CAACE,IAAI,CAAC;IACd,CAAC,CAAC,CAAC;IAEHL,UAAU,CAACM,IAAI,CACb,CAACC,CAAC,EAAEC,CAAC;MAAA,IAAAC,YAAA,EAAAC,YAAA;MAAA,OAAK,CAAC,EAAAD,YAAA,GAAAD,CAAC,CAACG,SAAS,cAAAF,YAAA,uBAAXA,YAAA,CAAaG,OAAO,KAAI,CAAC,KAAK,EAAAF,YAAA,GAAAH,CAAC,CAACI,SAAS,cAAAD,YAAA,uBAAXA,YAAA,CAAaE,OAAO,KAAI,CAAC,CAAC;IAAA,CACrE,CAAC;IAED,MAAMC,SAAS,GAAGb,UAAU,CAACc,MAAM,CAChCC,KAAK,IAAK,CAACvB,cAAc,CAACwB,GAAG,CAACD,KAAK,CAACX,EAAE,CAAC,IAAIW,KAAK,CAACE,MAAM,KAAK,QAC/D,CAAC;IAED,KAAK,MAAMF,KAAK,IAAIF,SAAS,EAAE;MAC7B,MAAMK,OAAO,GAAG;AACtB;AACA;AACA,iBAAiBH,KAAK,CAACI,OAAO;AAC9B,iBAAiBJ,KAAK,CAACK,YAAY;AACnC,cAAcL,KAAK,CAACM,aAAa;AACjC,cAAcN,KAAK,CAACO,IAAI;AACxB,eAAeP,KAAK,CAACQ,WAAW,IAAI,CAAC;AACrC,OAAO;;MAED;MACA,MAAMtC,kBAAkB,CAACiC,OAAO,CAAC;;MAEjC;MACA,IAAIH,KAAK,CAACM,aAAa,EAAE;QACvB,MAAMG,KAAK,GAAGT,KAAK,CAACM,aAAa,CAACI,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC;QACpD,MAAMvC,kBAAkB,CACtBsC,KAAK,EACL,eAAeT,KAAK,CAACI,OAAO,0BAA0BJ,KAAK,CAACQ,WAAW,EACzE,CAAC;MACH;MAEA/B,cAAc,CAACkC,GAAG,CAACX,KAAK,CAACX,EAAE,CAAC;IAC9B;IAEAR,YAAY,CAAC+B,OAAO,CAAC,gBAAgB,EAAEjC,IAAI,CAACkC,SAAS,CAAC,CAAC,GAAGpC,cAAc,CAAC,CAAC,CAAC;EAC7E,CAAC,CAAC;AACJ,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}