{"ast":null,"code":"import _objectSpread from\"C:/Users/anika/admin-panel/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";/* --------------------------------------------------------\r\n   üîî OrderNotifier.js  \r\n   Safe global listener for new orders ‚Üí Telegram + WhatsApp\r\n-------------------------------------------------------- */import{collection,onSnapshot}from\"firebase/firestore\";import{db}from\"../firebase\";import{sendTelegramUpdate,sendWhatsAppUpdate}from\"./notifications\";let listenerStarted=false;export const startOrderNotificationListener=()=>{if(listenerStarted){console.log(\"‚ö†Ô∏è Listener already running ‚Äî skipping duplicate.\");return;}// Ensure Firestore is ready before attaching listener\nif(!db){console.error(\"‚ùå Firestore not initialized yet!\");return;}listenerStarted=true;console.log(\"üöÄ Global Order Listener Started\");let notifiedOrders=new Set(JSON.parse(localStorage.getItem(\"notifiedOrders\")||\"[]\"));const ordersRef=collection(db,\"orders\");// SAFE ‚Äî db is guaranteed now\nonSnapshot(ordersRef,async snapshot=>{const ordersList=snapshot.docs.map(doc=>_objectSpread({id:doc.id},doc.data()));ordersList.sort((a,b)=>{var _b$timestamp,_a$timestamp;return(((_b$timestamp=b.timestamp)===null||_b$timestamp===void 0?void 0:_b$timestamp.seconds)||0)-(((_a$timestamp=a.timestamp)===null||_a$timestamp===void 0?void 0:_a$timestamp.seconds)||0);});const newOrders=ordersList.filter(order=>!notifiedOrders.has(order.id)&&order.status===\"booked\");for(const order of newOrders){const message=\"\\n\\uD83D\\uDCE6 *New Order Booked!*\\n\\n\\uD83E\\uDDFE *Order ID:* \".concat(order.orderId,\"\\n\\uD83D\\uDC64 *Customer:* \").concat(order.customerName,\"\\n\\uD83D\\uDCDE *Phone:* \").concat(order.customerPhone,\"\\n\\uD83D\\uDDD3\\uFE0F *Date:* \").concat(order.date,\"\\n\\uD83D\\uDCB0 *Total:* \\u20B9\").concat(order.totalAmount||0,\"\\n      \");// Telegram Admin Alert\nawait sendTelegramUpdate(message);// WhatsApp Customer\nif(order.customerPhone){const phone=order.customerPhone.replace(/\\D/g,\"\");await sendWhatsAppUpdate(phone,\"Your order #\".concat(order.orderId,\" is confirmed! Total: \\u20B9\").concat(order.totalAmount));}notifiedOrders.add(order.id);}localStorage.setItem(\"notifiedOrders\",JSON.stringify([...notifiedOrders]));});};","map":{"version":3,"names":["collection","onSnapshot","db","sendTelegramUpdate","sendWhatsAppUpdate","listenerStarted","startOrderNotificationListener","console","log","error","notifiedOrders","Set","JSON","parse","localStorage","getItem","ordersRef","snapshot","ordersList","docs","map","doc","_objectSpread","id","data","sort","a","b","_b$timestamp","_a$timestamp","timestamp","seconds","newOrders","filter","order","has","status","message","concat","orderId","customerName","customerPhone","date","totalAmount","phone","replace","add","setItem","stringify"],"sources":["C:/Users/anika/admin-panel/src/utils/OrderNotifier.js"],"sourcesContent":["/* --------------------------------------------------------\r\n   üîî OrderNotifier.js  \r\n   Safe global listener for new orders ‚Üí Telegram + WhatsApp\r\n-------------------------------------------------------- */\r\n\r\nimport { collection, onSnapshot } from \"firebase/firestore\";\r\nimport { db } from \"../firebase\";\r\nimport { sendTelegramUpdate, sendWhatsAppUpdate } from \"./notifications\";\r\n\r\nlet listenerStarted = false;\r\n\r\nexport const startOrderNotificationListener = () => {\r\n  if (listenerStarted) {\r\n    console.log(\"‚ö†Ô∏è Listener already running ‚Äî skipping duplicate.\");\r\n    return;\r\n  }\r\n\r\n  // Ensure Firestore is ready before attaching listener\r\n  if (!db) {\r\n    console.error(\"‚ùå Firestore not initialized yet!\");\r\n    return;\r\n  }\r\n\r\n  listenerStarted = true;\r\n  console.log(\"üöÄ Global Order Listener Started\");\r\n\r\n  let notifiedOrders = new Set(\r\n    JSON.parse(localStorage.getItem(\"notifiedOrders\") || \"[]\")\r\n  );\r\n\r\n  const ordersRef = collection(db, \"orders\"); // SAFE ‚Äî db is guaranteed now\r\n\r\n  onSnapshot(ordersRef, async (snapshot) => {\r\n    const ordersList = snapshot.docs.map((doc) => ({\r\n      id: doc.id,\r\n      ...doc.data(),\r\n    }));\r\n\r\n    ordersList.sort(\r\n      (a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)\r\n    );\r\n\r\n    const newOrders = ordersList.filter(\r\n      (order) => !notifiedOrders.has(order.id) && order.status === \"booked\"\r\n    );\r\n\r\n    for (const order of newOrders) {\r\n      const message = `\r\nüì¶ *New Order Booked!*\r\n\r\nüßæ *Order ID:* ${order.orderId}\r\nüë§ *Customer:* ${order.customerName}\r\nüìû *Phone:* ${order.customerPhone}\r\nüóìÔ∏è *Date:* ${order.date}\r\nüí∞ *Total:* ‚Çπ${order.totalAmount || 0}\r\n      `;\r\n\r\n      // Telegram Admin Alert\r\n      await sendTelegramUpdate(message);\r\n\r\n      // WhatsApp Customer\r\n      if (order.customerPhone) {\r\n        const phone = order.customerPhone.replace(/\\D/g, \"\");\r\n        await sendWhatsAppUpdate(\r\n          phone,\r\n          `Your order #${order.orderId} is confirmed! Total: ‚Çπ${order.totalAmount}`\r\n        );\r\n      }\r\n\r\n      notifiedOrders.add(order.id);\r\n    }\r\n\r\n    localStorage.setItem(\"notifiedOrders\", JSON.stringify([...notifiedOrders]));\r\n  });\r\n};\r\n"],"mappings":"+GAAA;AACA;AACA;AACA,2DAEA,OAASA,UAAU,CAAEC,UAAU,KAAQ,oBAAoB,CAC3D,OAASC,EAAE,KAAQ,aAAa,CAChC,OAASC,kBAAkB,CAAEC,kBAAkB,KAAQ,iBAAiB,CAExE,GAAI,CAAAC,eAAe,CAAG,KAAK,CAE3B,MAAO,MAAM,CAAAC,8BAA8B,CAAGA,CAAA,GAAM,CAClD,GAAID,eAAe,CAAE,CACnBE,OAAO,CAACC,GAAG,CAAC,mDAAmD,CAAC,CAChE,OACF,CAEA;AACA,GAAI,CAACN,EAAE,CAAE,CACPK,OAAO,CAACE,KAAK,CAAC,kCAAkC,CAAC,CACjD,OACF,CAEAJ,eAAe,CAAG,IAAI,CACtBE,OAAO,CAACC,GAAG,CAAC,kCAAkC,CAAC,CAE/C,GAAI,CAAAE,cAAc,CAAG,GAAI,CAAAC,GAAG,CAC1BC,IAAI,CAACC,KAAK,CAACC,YAAY,CAACC,OAAO,CAAC,gBAAgB,CAAC,EAAI,IAAI,CAC3D,CAAC,CAED,KAAM,CAAAC,SAAS,CAAGhB,UAAU,CAACE,EAAE,CAAE,QAAQ,CAAC,CAAE;AAE5CD,UAAU,CAACe,SAAS,CAAE,KAAO,CAAAC,QAAQ,EAAK,CACxC,KAAM,CAAAC,UAAU,CAAGD,QAAQ,CAACE,IAAI,CAACC,GAAG,CAAEC,GAAG,EAAAC,aAAA,EACvCC,EAAE,CAAEF,GAAG,CAACE,EAAE,EACPF,GAAG,CAACG,IAAI,CAAC,CAAC,CACb,CAAC,CAEHN,UAAU,CAACO,IAAI,CACb,CAACC,CAAC,CAAEC,CAAC,QAAAC,YAAA,CAAAC,YAAA,OAAK,CAAC,EAAAD,YAAA,CAAAD,CAAC,CAACG,SAAS,UAAAF,YAAA,iBAAXA,YAAA,CAAaG,OAAO,GAAI,CAAC,GAAK,EAAAF,YAAA,CAAAH,CAAC,CAACI,SAAS,UAAAD,YAAA,iBAAXA,YAAA,CAAaE,OAAO,GAAI,CAAC,CAAC,EACrE,CAAC,CAED,KAAM,CAAAC,SAAS,CAAGd,UAAU,CAACe,MAAM,CAChCC,KAAK,EAAK,CAACxB,cAAc,CAACyB,GAAG,CAACD,KAAK,CAACX,EAAE,CAAC,EAAIW,KAAK,CAACE,MAAM,GAAK,QAC/D,CAAC,CAED,IAAK,KAAM,CAAAF,KAAK,GAAI,CAAAF,SAAS,CAAE,CAC7B,KAAM,CAAAK,OAAO,mEAAAC,MAAA,CAGFJ,KAAK,CAACK,OAAO,gCAAAD,MAAA,CACbJ,KAAK,CAACM,YAAY,6BAAAF,MAAA,CACrBJ,KAAK,CAACO,aAAa,kCAAAH,MAAA,CACnBJ,KAAK,CAACQ,IAAI,mCAAAJ,MAAA,CACTJ,KAAK,CAACS,WAAW,EAAI,CAAC,YAC9B,CAED;AACA,KAAM,CAAAxC,kBAAkB,CAACkC,OAAO,CAAC,CAEjC;AACA,GAAIH,KAAK,CAACO,aAAa,CAAE,CACvB,KAAM,CAAAG,KAAK,CAAGV,KAAK,CAACO,aAAa,CAACI,OAAO,CAAC,KAAK,CAAE,EAAE,CAAC,CACpD,KAAM,CAAAzC,kBAAkB,CACtBwC,KAAK,gBAAAN,MAAA,CACUJ,KAAK,CAACK,OAAO,iCAAAD,MAAA,CAA0BJ,KAAK,CAACS,WAAW,CACzE,CAAC,CACH,CAEAjC,cAAc,CAACoC,GAAG,CAACZ,KAAK,CAACX,EAAE,CAAC,CAC9B,CAEAT,YAAY,CAACiC,OAAO,CAAC,gBAAgB,CAAEnC,IAAI,CAACoC,SAAS,CAAC,CAAC,GAAGtC,cAAc,CAAC,CAAC,CAAC,CAC7E,CAAC,CAAC,CACJ,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}